name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Version bump type
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest
        run: |
          tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "Latest tag: $tag"

      - name: Compute next version
        id: next
        run: |
          current="${{ steps.latest.outputs.tag }}"
          current="${current#v}"
          IFS='.' read -r major minor patch <<< "$current"

          case "${{ inputs.bump }}" in
            patch) patch=$((patch + 1)) ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            major) major=$((major + 1)); minor=0; patch=0 ;;
          esac

          version="v${major}.${minor}.${patch}"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Next version: $version"

      - name: Create tag
        run: |
          git tag "${{ steps.next.outputs.version }}"
          git push origin "${{ steps.next.outputs.version }}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.next.outputs.version }}" \
            --title "${{ steps.next.outputs.version }}" \
            --generate-notes
